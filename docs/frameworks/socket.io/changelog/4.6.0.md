---
title: Versiyon 4.6.0
seoTitle: Socket.IO Versiyon 4.6.0 - Yenilikler ve Hata Düzeltmeleri
sidebar_position: 11
description: Socket.IO versiyon 4.6.0 güncellemesi, yeni özellikler ve hata düzeltmeleri içermektedir. Ayrıca bağlantı durumu kurtarma, promise tabanlı onaylar gibi önemli geliştirmeleri barındırmaktadır.
tags: 
  - Socket.IO
  - WebSocket
  - Geliştirme
  - Olay Tabanlı Programlama
keywords: 
  - Socket.IO
  - WebSocket
  - Geliştirme
  - Olay Tabanlı Programlama
---
*7 Şubat 2023*

## Sunucu

### Hata Düzeltmeleri

- uzaktan soket için zaman aşımı yöntemi ekleyin ([#4558](https://github.com/socketio/socket.io/issues/4558)) ([0c0eb00](https://github.com/socketio/socket.io/commit/0c0eb0016317218c2be3641e706cfaa9bea39a2d))
- **tipler:** zaman aşımı ile doğru emit türü belirleme ([f3ada7d](https://github.com/socketio/socket.io/commit/f3ada7d8ccc02eeced2b9b9ac8e4bc921eb630d2))

### Özellikler

#### :::info Promise Tabanlı Onaylar

Bu commit, onaylarla ilgili bazı sözdizimsel şekiller ekler:

- `emitWithAck()`

```js
try {
  const responses = await io.timeout(1000).emitWithAck("some-event");
  console.log(responses); // her istemci için bir yanıt
} catch (e) {
  // bazı istemciler belirtilen gecikmede olayı onaylamadı
}

io.on("connection", async (socket) => {
  const response = await socket.emitWithAck("hello", "world");
  
  try {
    const response = await socket.timeout(1000).emitWithAck("hello", "world");
  } catch (err) {
    // istemci belirtilen gecikmede olayı onaylamadı
  }
});
```

- `serverSideEmitWithAck()`

```js
try {
  const responses = await io.timeout(1000).serverSideEmitWithAck("some-event");
  console.log(responses); // sunucu başına bir yanıt (kendisi hariç)
} catch (e) {
  // bazı sunucular belirtilen gecikmede olayı onaylamadı
}
```

[184f3cf](https://github.com/socketio/socket.io/commit/184f3cf7af57acc4b0948eee307f25f8536eb6c8) eklenmiştir.

#### :::note Bağlantı Durumu Kurtarma

Bu özellik, bir istemcinin geçici bir bağlantı kopmasından sonra yeniden bağlanmasını ve durumunu geri yüklemesini sağlar:

- kimlik
- odalar
- veri
- kaçırılan paketler

Kullanım:

```js
import { Server } from "socket.io";

const io = new Server({
  connectionStateRecovery: {
    maxDisconnectionDuration: 2 * 60 * 1000,
    skipMiddlewares: true,
  },
});

io.on("connection", (socket) => {
  console.log(socket.recovered); // durumun kurtarılıp kurtarılmadığı
});
```

Nasıl çalıştığına dair bilgiler:

- sunucu el sıkışma sırasında bir oturum kimliği gönderir (bu, mevcut `id` niteliğinden farklıdır, bu açık ve serbestçe paylaşılabilir)
- sunucu her pakete bir offset de ekler (veri dizisinin sonunda eklenen, geriye dönük uyumluluk için)
- geçici bir bağlantı kopması durumunda, sunucu belirli bir gecikme süresi boyunca istemci durumunu saklar (adaptör düzeyinde uygulanmıştır)
- yeniden bağlanıldığında, istemci hem oturum kimliğini hem de işlediği son offset'i gönderir ve sunucu durumu geri yüklemeye çalışır

Bellek içi adaptör bu özelliği zaten desteklemekte ve Postgres ile MongoDB adaptörlerini yakında güncelleyerek bu özelliği destekleyeceğiz. Ayrıca, bu özelliği destekleyecek yeni bir adaptör oluşturacağız: [Redis Streams](https://redis.io/docs/data-types/streams/).

[54d5ee0](https://github.com/socketio/socket.io/commit/54d5ee05a684371191e207b8089f09fc24eb5107) eklenmiştir.

#### :::tip Express Ara Katmanları ile Gerçek Uyumluluk

Bu özellik, Socket.IO ara katmanları klasik bir HTTP istek/yanıt döngüsü sırasında çalışmadığından, Engine.IO düzeyinde ara katmanları uygular ve Socket.IO ara katmanları ad alanı yetkilendirme için tasarlanmıştır.

Sözdizimi:

```js
io.engine.use((req, res, next) => {
  // bir şey yap
  next();
});

// express-session ile
import session from "express-session";

io.engine.use(session({
  secret: "keyboard cat",
  resave: false,
  saveUninitialized: true,
  cookie: { secure: true }
}));

// helmet ile
import helmet from "helmet";

io.engine.use(helmet());
```

allowRequest seçeneği ve "headers" olayı kullanılarak bir geçici çözüm mümkün olmuştu, ancak bu çok daha düzenli hissettiriyor ve yükseltme istekleriyle de çalışıyor.

[24786e7](https://github.com/socketio/engine.io/commit/24786e77c5403b1c4b5a2bc84e2af06f9187f74a) eklenmiştir.

#### :::warning Bağlantı Kesilmesi ve Ayrılma Olaylarındaki Hata Ayrıntıları

`disconnect` olayı artık bağlantının kesilme nedenine dair ek ayrıntılar içerecektir.

```js
io.on("connection", (socket) => {
  socket.on("disconnect", (reason, description) => {
    console.log(description);
  });
});
```

[8aa9499](https://github.com/socketio/socket.io/commit/8aa94991cee5518567d6254eec04b23f81510257) eklenmiştir.

#### :::note Boş Alt Ad Alanlarının Otomatik Olarak Kaldırılması

Bu commit, "cleanupEmptyChildNamespaces" adlı yeni bir seçenek ekler. Bu seçenek etkinleştirildiğinde (varsayılan olarak devre dışı), bir soket dinamik bir ad alanından bağlantısını kestiğinde ve başka hiçbir soket bağlı değilse, ad alanı temizlenecek ve adaptörü kapatılacaktır.

```js
import { createServer } from "node:http";
import { Server } from "socket.io";

const httpServer = createServer();
const io = new Server(httpServer, {
  cleanupEmptyChildNamespaces: true
});
```

[5d9220b](https://github.com/socketio/socket.io/commit/5d9220b69adf73e086c27bbb63a4976b348f7c4c) eklenmiştir.

#### :::info Yeni "addTrailingSlash" Seçeneği

Varsayılan olarak eklenen son çarpraz, artık devre dışı bırakılabilir:

```js
import { createServer } from "node:http";
import { Server } from "socket.io";

const httpServer = createServer();
const io = new Server(httpServer, {
  addTrailingSlash: false
});
```

Yukarıdaki örnekte, istemciler son çarprazı atlayabilir ve `/socket.io` yerine `/socket.io/` kullanabilir.

[d0fd474](https://github.com/socketio/engine.io/commit/d0fd4746afa396297f07bb62e539b0c1c4018d7c) eklenmiştir.

### Performans İyileştirmeleri

- yayılma sırasında WebSocket çerçevelerini önceden hesaplayın ([da2b542](https://github.com/socketio/socket.io/commit/da2b54279749adc5279c9ac4742b01b36c01cff0))

### Bağımlılıklar

- [`engine.io@~6.4.0`](https://github.com/socketio/engine.io/releases/tag/6.4.0) (https://github.com/socketio/engine.io/compare/6.2.1...6.4.0)
- [`ws@~8.11.0`](https://github.com/websockets/ws/releases/tag/8.11.0) (https://github.com/websockets/ws/compare/8.2.3...8.11.0)

## İstemci

### Hata Düzeltmeleri

- **tipler:** tarayıcıya özgü türleri açığa çıkarmayın ([4d6d95e](https://github.com/socketio/socket.io-client/commit/4d6d95e0792efd43b78c760b055764fef02ebc9e))
- manager.socket()'in etkin bir soket döndürmesini sağlayın ([b7dd891](https://github.com/socketio/socket.io-client/commit/b7dd891e890461d33a104ca9187d5cd30d6f76af))
- **tipler:** zaman aşımı ile doğru emit türü belirleme ([#1570](https://github.com/socketio/socket.io-client/issues/1570)) ([33e4172](https://github.com/socketio/socket.io-client/commit/33e417258c9a5697e001163971ae87821e9c097f))

### Özellikler

#### :::info Yeni "addTrailingSlash" Seçeneği

Varsayılan olarak eklenen son çarpraz, artık devre dışı bırakılabilir:

```js
import { io } from "socket.io-client";

const socket = io("https://example.com", {
  addTrailingSlash: false
});
```

Yukarıdaki örnekte, istek URL'si `https://example.com/socket.io` yerine `https://example.com/socket.io/` olacaktır.

[21a6e12](https://github.com/socketio/engine.io-client/commit/21a6e1219add92157c5442537d24fbe1129a50f5) eklenmiştir.

#### :::note Promise Tabanlı Onaylar

Bu commit, onaylarla ilgili bazı sözdizimsel şekiller ekler:

```js
// zaman aşımı olmadan
const response = await socket.emitWithAck("hello", "world");

// belirli bir zaman aşımı ile
try {
  const response = await socket.timeout(1000).emitWithAck("hello", "world");
} catch (err) {
  // sunucu belirtilen gecikmede olayı onaylamadı
}
```

Not: [Promise desteklemeyen](https://caniuse.com/promises) ortamlarda, bu özelliği kullanmak için bir polyfill eklenmesi gerekecektir.

[47b979d](https://github.com/socketio/socket.io-client/commit/47b979d57388e9b5e9a332f3f4a9873211f0d844) eklenmiştir.

#### :::tip Bağlantı Durumu Kurtarma

Bu özellik, bir istemcinin geçici bir bağlantı kopmasından sonra yeniden bağlanmasını ve kimliğini geri yüklemesini sağlar ve bağlantı kopma süresi boyunca kaçırılan paketleri alır. Sunucu tarafında etkinleştirilmesi gerekir.

`socket` nesnesine yeni bir boolean niteliği olan `recovered` eklenmiştir:

```js
socket.on("connect", () => {
  console.log(socket.recovered); // kurtarmanın başarılı olup olmadığı
});
```

[54d5ee0](https://github.com/socketio/socket.io/commit/54d5ee05a684371191e207b8089f09fc24eb5107) (sunucu) ve [b4e20c5](https://github.com/socketio/socket.io-client/commit/b4e20c5c709b5e9cc03ee9b6bd1d576f4810a817) (istemci) eklenmiştir.

#### :::warning Yeniden Deneme Mekanizması

İki yeni seçenek mevcuttur:

- `retries`: maksimum yeniden deneme sayısı. Limitin üzerinde, paket atılacaktır.
- `ackTimeout`: onaylama beklerken kullanılan varsayılan zaman aşımı, milisaniye cinsindendir (zaten mevcut `timeout` seçeneği ile karıştırılmamalıdır, bu seçeneği Yöneticinin bağlantı sırasında kullanır)

```js
const socket = io({
  retries: 3,
  ackTimeout: 10000
});

// örtük onay
socket.emit("my-event");

// açık onay
socket.emit("my-event", (err, val) => { /* ... */ });

// özel zaman aşımı (bu durumda ackTimeout isteğe bağlıdır)
socket.timeout(5000).emit("my-event", (err, val) => { /* ... */ });
```

Yukarıdaki tüm örneklerde, "my-event" en fazla 4 kez (1 + 3) gönderilecektir, sunucu bir onay gönderene kadar.

Her pakete benzersiz bir kimlik atamak, sunucu tarafında tekrar etmeyi önlemek için kullanıcıya aittir.

[655dce9](https://github.com/socketio/socket.io-client/commit/655dce97556a1ea44a60db6b694d0cfd85b5f70f) eklenmiştir.

### Bağımlılıklar

- [`engine.io-client@~6.4.0`](https://github.com/socketio/engine.io-client/releases/tag/6.4.0) ([diff](https://github.com/socketio/engine.io-client/compare/6.2.3...6.4.0))
- [`ws@~8.11.0`](https://github.com/websockets/ws/releases/tag/8.11.0) ([diff](https://github.com/websockets/ws/compare/8.2.3...8.11.0))